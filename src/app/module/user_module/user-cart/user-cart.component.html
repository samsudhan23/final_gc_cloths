
@if(allCartList.length == 0){
<div class="min-h-screen bg-white">
    <div class="container mx-auto px-4 py-8 md:py-16">
        <div class="flex flex-col items-center justify-center py-16 px-4 text-center">
            <img src="https://c.animaapp.com/mgfcgz6sqvonyu/img/ai_3.png" alt="empty cart illustration"
                class="w-full max-w-md h-auto mb-8" loading="lazy" />
            <i class="pi pi-shopping-cart w-16 h-16 text-neutral-400 mb-4" style="font-size: 2rem"></i>
            <h2 class="font-heading font-semibold text-2xl text-foreground mb-2">
                Your cart is empty
            </h2>
            <p class="text-base text-neutral-600 mb-6 max-w-md">
                Looks like you haven't added anything to your cart yet. Start shopping to fill it up!
            </p>
            <p-button class="" label="Start Shopping" icon="pi pi-shopping-cart" (click)="goToProductShoping()" />
        </div>
    </div>
</div>
}
@if(allCartList.length > 0){
<div class="min-h-screen bg-white">
    <div class="container mx-auto px-4 py-8 md:py-16">
        <header class="mb-8">
            <h1 class="font-heading font-bold text-3xl md:text-4xl text-foreground">
                Your Shopping Cart
            </h1>
            <p class="text-base text-neutral-600 mt-2">
                {{allCartList.length}} item in your cart
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <!-- Select All Checkbox -->
                <div class="mb-4 flex items-center gap-2 p-3 bg-neutral-50 rounded-lg border border-border">
                    <p-checkbox [(ngModel)]="selectAll" 
                                (onChange)="onSelectAll($event.checked)"
                                [binary]="true"
                                inputId="selectAll"></p-checkbox>
                    <label for="selectAll" class="font-medium text-foreground cursor-pointer">
                        Select All ({{selectedItems.size}} of {{allCartList.length}} selected)
                    </label>
                </div>
                
                <!-- @for(item of allCartList; track trackByCartItem; let i = $index){ -->
                <section aria-label="Cart items" *ngFor="let item of allCartList; let i = index">
                    <div>
                        <div
                            class="relative rounded-xl p-4 md:p-6 transition-all duration-200 ease-in hover:scale-[1.02] hover:bg-neutral-50 mb-4 border border-border">
                            <Button (click)="deleteCart(item)"
                                class="absolute top-2 right-2 bg-transparent text-neutral-600 hover:bg-neutral-200 hover:text-neutral-900"
                                aria-label="Remove item">
                                <p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="danger" />
                            </Button>
                            <!-- @for(ite of item; track ite){ -->
                            <div class="flex flex-col md:flex-row gap-4 md:gap-6">
                                <!-- Checkbox on the left -->
                                <div class="flex items-start pt-2">
                                    <p-checkbox [ngModel]="isItemSelected(item)"
                                                (onChange)="onItemSelect(item, $event.checked)"
                                                [binary]="true"
                                                [inputId]="'item-' + i"></p-checkbox>
                                </div>
                                
                                <div class="w-full md:w-[30%] flex-shrink-0">
                                    <img [src]="item?.productId?.images" class="w-full h-auto rounded-lg object-cover"
                                        loading="lazy" />
                                </div>

                                <div class="flex-1 flex flex-col gap-3">
                                    <div>
                                        <h3 (click)="goToProduct(item?.productId)"
                                            class="cursor-pointer font-heading font-semibold text-lg text-foreground hover:text-blue-700 ">
                                            {{item?.productId?.productName}}
                                        </h3>
                                        <p class="text-base text-foreground mt-1">{{item?.productId?.productName}}</p>
                                    </div>

                                    <!-- <a
                                        class="text-secondary text-sm font-medium hover:underline transition-all duration-200 ease-in">
                                        Buy 2 Get 1 Free
                                    </a> -->

                                    <div class="flex items-center gap-2 text-sm text-neutral-700">

                                        <i class="pi pi-truck text-success"></i>
                                        <span>Delivery by Dec 28</span>
                                    </div>

                                    <div>
                                        <form [formGroup]="getFormGroup(i)"
                                            class="flex flex-col sm:flex-row gap-3 mt-2">
                                            <div class="flex-1">
                                                <label class="text-sm font-medium text-foreground mb-1 block">
                                                    Size
                                                </label>
                                                <p-select [options]="item?.productId?.sizeStock" formControlName="size"
                                                    (onChange)="onSizeChange($event , i)" optionLabel="size"
                                                    appendTo="body" placeholder="Select a Size"
                                                    class="w-full md:w-56" />
                                            </div>

                                            <div class="flex-1">
                                                <label class="text-sm font-medium text-foreground mb-1 block">
                                                    Quantity
                                                </label>
                                                <p-select (onChange)="onQuantityChange($event , item)"
                                                    [options]="quantity[i]" formControlName="quantity"
                                                    optionLabel="value" appendTo="body" placeholder="Select a Quantity"
                                                    class="w-full md:w-56" />

                                            </div>
                                        </form>
                                    </div>

                                    <div class="flex flex-wrap items-baseline gap-2 mt-2">
                                        <span class="text-2xl font-bold text-primary font-heading">
                                            <span class="text-black font-medium">₹</span> {{item?.productId?.price}}
                                        </span>
                                        <span class="text-base text-neutral-500 line-through">
                                            ₹{{item?.productId?.discountPrice}}
                                        </span>
                                        <!-- <span class="text-base text-neutral-500 line-through">
                                            $49.99
                                        </span> -->
                                        <!-- <span class="text-sm font-bold text-tertiary">
                                            Save $20.00
                                        </span> -->
                                    </div>
                                </div>
                            </div>
                            <!-- } -->
                        </div>
                    </div>

                </section>
                <!-- } -->
            </div>
            <!-- @if(allCartList.length > 0){ -->
            <div class="lg:col-span-1">
                <div class="p-6 top-4 border border-border bg-card rounded-xl">
                    <h2 class="font-heading font-semibold text-xl text-foreground mb-4">
                        Price Summary
                    </h2>

                    <div class="space-y-3">
                        <div class="flex justify-between text-base text-foreground">
                            <span>Subtotal</span>
                            <span class="font-medium">₹ {{totalSelectedPrductCost.subtotal ?? 0}}</span>
                        </div>

                        <!-- <div class="flex justify-between text-base text-tertiary">
                            <span>Discount</span>
                            <span class="font-medium">-$20.00</span>
                        </div> -->

                        <div class="flex justify-between text-base text-foreground">
                            <span>Delivery</span>
                            <span class="font-medium">
                                ₹ {{deliveryCharge ?? 0}}
                            </span>
                        </div>

                        <div class="border-t border-border pt-3 mt-3">
                            <div class="flex justify-between text-lg font-bold text-primary font-heading">
                                <span>Total</span>
                                <span>₹ {{totalSelectedPrductCost.totalCost ?? 0}}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <p-button
                        label="Proceed to Checkout ({{selectedItems.size}} items)"
                        icon="pi pi-shopping-bag"
                        class="w-full"
                        (onClick)="proceedToCheckout()"
                        [disabled]="selectedItems.size === 0"
                        severity="info"
                        styleClass="w-full py-6 text-base font-normal">
                    </p-button>
                    <!-- <p-button
                        class="w-full py-6 text-base font-normal bg-secondary text-secondary-foreground hover:bg-secondary/90 transition-all duration-200 ease-in"
                        label=" Proceed to Checkout" severity="info" /> -->

                </div>
            </div>
            <!-- } -->
        </div>

        <!-- <div class="mt-12">
            <img src="https://c.animaapp.com/mgfcgz6sqvonyu/img/ai_2.png" alt="secure payment illustration"
                class="w-full max-w-2xl mx-auto h-auto rounded-lg" loading="lazy" />
        </div> -->

        <!-- <TrustIndicators />  @for(indicator of indicators; track item){}-->
        <section class="mt-12 py-8 px-4 md:px-8 bg-neutral-50 rounded-lg border border-border">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                @for(indicator of indicators; track indicator){
                <div class="flex flex-col items-center text-center gap-3">
                    <div class="w-16 h-16 rounded-full bg-secondary/10 flex items-center justify-center">
                        <i class="pi rounded-full p-3" [ngClass]="'pi-' + indicator.icon"
                            style="font-size: 2rem; background-color: antiquewhite;"></i>
                    </div>
                    <div>
                        <h3 class="font-heading font-semibold text-base text-foreground">
                            {{indicator.label}}
                        </h3>
                        <p class="text-sm text-neutral-600 mt-1">
                            {{indicator.description}}
                        </p>
                    </div>
                </div>
                }
            </div>
        </section>
    </div>
</div>

<!-- Checkout Dialog -->
<p-dialog 
    [(visible)]="checkoutDialogVisible" 
    [modal]="true" 
    [style]="{width: '90vw', maxWidth: '900px'}"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    header="Checkout"
    (onHide)="closeCheckoutDialog()">
    
    <!-- Address Selection Step -->
    <div *ngIf="checkoutStep === 'address'" class="checkout-step">
        <h3 class="step-title">Select Delivery Address</h3>
        <app-deliveryaddress 
            [selectMode]="true"
            [selectedAddressId]="selectedAddress?._id"
            (addressSelected)="onAddressSelected($event)">
        </app-deliveryaddress>
        
        <div class="checkout-actions" *ngIf="selectedAddress">
            <p-card>
                <div class="selected-address-summary">
                    <h4>Selected Address:</h4>
                    <p><strong>{{ selectedAddress.fullName }}</strong></p>
                    <p>{{ selectedAddress.addressLine }}</p>
                    <p *ngIf="selectedAddress.landmark">{{ selectedAddress.landmark }}</p>
                    <p>{{ selectedAddress.city }}, {{ selectedAddress.state }} - {{ selectedAddress.postalCode || selectedAddress.pincode }}</p>
                    <p>{{ selectedAddress.country }}</p>
                    <p>Phone: {{ selectedAddress.phone || selectedAddress.phoneNumber }}</p>
                    <p *ngIf="selectedAddress.alternatePhoneNumber || selectedAddress.altPhoneNumber">
                        Alternate: {{ selectedAddress.alternatePhoneNumber || selectedAddress.altPhoneNumber }}
                    </p>
                </div>
            </p-card>
        </div>
    </div>

    <!-- Payment Step -->
    <div *ngIf="checkoutStep === 'payment'" class="checkout-step">
        <app-payment 
            [selectedAddress]="selectedAddress"
            [orderSummary]="totalSelectedPrductCost"
            [selectedItems]="getSelectedCartItems()"
            (paymentSuccess)="onPaymentSuccess($event)"
            (paymentError)="onPaymentError($event)"
            (goBack)="backToAddress()">
        </app-payment>
    </div>

    <ng-template pTemplate="footer">
        <div class="dialog-footer" *ngIf="checkoutStep === 'address'">
            <p-button 
                label="Cancel" 
                icon="pi pi-times" 
                (click)="closeCheckoutDialog()" 
                severity="secondary" 
                [outlined]="true">
            </p-button>
            <p-button 
                label="Continue to Payment" 
                icon="pi pi-arrow-right" 
                (click)="proceedToPayment()" 
                [disabled]="!selectedAddress"
                severity="primary">
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />
}